#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
from bs4 import BeautifulSoup
from selenium import webdriver
import pickle

chromedriver = "../chromedriver"
os.environ["webdriver.chrome.driver"] = chromedriver
driver = webdriver.Chrome(chromedriver)


#all concepts involved
concepts=[{"code":"xaxq","name":"雄安新区","codeAlias":"xaxq"},{"code":"3dbl","name":"3D玻璃","codeAlias":"3dbl"},{"code":"360syh","name":"360私有化","codeAlias":"360gn"},{"code":"3ddy","name":"3D打印","codeAlias":"3ddy"},{"code":"3dyj","name":"3D眼镜","codeAlias":"3dyj"},{"code":"3g","name":"3G","codeAlias":"3g"},{"code":"4gtxjs","name":"4G","codeAlias":"4gtxjs"},{"code":"5g","name":"5G","codeAlias":"5g"},{"code":"af","name":"安防","codeAlias":"af"},{"code":"amc","name":"AMC","codeAlias":"amc"},{"code":"bddh","name":"北斗导航","codeAlias":"bddh"},{"code":"bx","name":"保险","codeAlias":"bxg"},{"code":"by","name":"白银","codeAlias":"by"},{"code":"cdcl","name":"超导","codeAlias":"cdcl"},{"code":"cdz","name":"充电桩","codeAlias":"cdz"},{"code":"cgbx","name":"参股保险","codeAlias":"cgbx"},{"code":"cgjj","name":"参股基金","codeAlias":"cgjj"},{"code":"cgqh","name":"参股期货","codeAlias":"cgqh"},{"code":"cgqs","name":"参股券商","codeAlias":"cgqs"},{"code":"cgyh","name":"参股银行","codeAlias":"cgyh"},{"code":"cgz","name":"草甘膦","codeAlias":"cgz"},{"code":"cl","name":"材料","codeAlias":"xcl"},{"code":"clw","name":"车联网","codeAlias":"clw"},{"code":"cp","name":"彩票","codeAlias":"cp"},{"code":"ct","name":"创投","codeAlias":"ct"},{"code":"cxg","name":"次新股","codeAlias":"cxg"},{"code":"cytq","name":"成渝特区","codeAlias":"cytq"},{"code":"dah","name":"冬奥会","codeAlias":"dah"},{"code":"ddsj","name":"大数据","codeAlias":"ddsj"},{"code":"ddwlc","name":"电动物流车","codeAlias":"ddwlc"},{"code":"dfj","name":"大飞机","codeAlias":"dfj"},{"code":"dkfx","name":"低空飞行","codeAlias":"dkfx"},{"code":"dlxy","name":"电力行业","codeAlias":"dlxy"},{"code":"drn","name":"地热能","codeAlias":"drn"},{"code":"ds7","name":"电商","codeAlias":"ds7"},{"code":"dsn","name":"迪士尼","codeAlias":"dsn"},{"code":"dzy","name":"电子烟","codeAlias":"dzy"},{"code":"dzyj","name":"电子元件","codeAlias":"dzyj"},{"code":"et","name":"二胎","codeAlias":"et"},{"code":"fdc","name":"钒电池","codeAlias":"fdc"},{"code":"fhg","name":"氟化工","codeAlias":"fhg"},{"code":"fjzmq","name":"福建自贸区","codeAlias":"fjzmq"},{"code":"fn","name":"风能","codeAlias":"fn"},{"code":"fqzl","name":"废气治理","codeAlias":"fqzl"},{"code":"fsrl","name":"分散染料","codeAlias":"fsrl"},{"code":"gchm","name":"国产航母","codeAlias":"gchm"},{"code":"gdgzgg","name":"广东国资改革","codeAlias":"gdgzgg"},{"code":"gf","name":"光伏","codeAlias":"gf"},{"code":"gfcl2","name":"固废处理","codeAlias":"gfcl2"},{"code":"gksy","name":"港口水运","codeAlias":"gksy"},{"code":"gqzr","name":"股权转让","codeAlias":"gqzr"},{"code":"gsz","name":"高送转","codeAlias":"gsz"},{"code":"gt","name":"钢铁","codeAlias":"gt"},{"code":"gxdc","name":"共享单车","codeAlias":"gxdc"},{"code":"gxqc","name":"共享汽车","codeAlias":"gxqc"},{"code":"gy400","name":"工业4.0","codeAlias":"gy400"},{"code":"hd","name":"核电","codeAlias":"hd"},{"code":"hd3","name":"恒大","codeAlias":"hdgn"},{"code":"hg","name":"混改","codeAlias":"hg"},{"code":"hj5","name":"黄金","codeAlias":"hj5"},{"code":"hk","name":"航空","codeAlias":"hk"},{"code":"hlwjr2","name":"互联网金融","codeAlias":"hlwjr2"},{"code":"hqgg","name":"沪企改革","codeAlias":"shgzgg"},{"code":"hy","name":"航运","codeAlias":"hy"},{"code":"ip","name":"IP","codeAlias":"ip"},{"code":"jcdl","name":"集成电路","codeAlias":"jcdl"},{"code":"jdxy","name":"家电行业","codeAlias":"jdxy"},{"code":"jg","name":"军工","codeAlias":"jg"},{"code":"jgg","name":"金改","codeAlias":"jgg"},{"code":"jjjyth","name":"京津冀一体化","codeAlias":"jjjyth"},{"code":"jkss","name":"借壳上市","codeAlias":"jkss"},{"code":"jkzg","name":"健康中国","codeAlias":"jkzg"},{"code":"jmrh","name":"军民融合","codeAlias":"jmrh"},{"code":"jnhb","name":"节能环保","codeAlias":"jnhb"},{"code":"jp","name":"举牌","codeAlias":"jp"},{"code":"jric","name":"金融IC卡","codeAlias":"jric"},{"code":"jrrj","name":"金融软件","codeAlias":"jrrj"},{"code":"jycx","name":"基因测序","codeAlias":"jycx"},{"code":"ka","name":"抗癌","codeAlias":"ka"},{"code":"kjds","name":"跨境电商","codeAlias":"kjds"},{"code":"kzy","name":"壳资源","codeAlias":"kzy"},{"code":"l","name":"铝","codeAlias":"l"},{"code":"lbs","name":"蓝宝石","codeAlias":"lbs"},{"code":"lchb","name":"两材合并","codeAlias":"lchb"},{"code":"ldc","name":"锂电池","codeAlias":"ldc"},{"code":"ledzm","name":"LED照明","codeAlias":"ledzm"},{"code":"lhg","name":"磷化工","codeAlias":"lhg"},{"code":"ll","name":"冷链","codeAlias":"ll"},{"code":"lqlz","name":"林权流转","codeAlias":"lqlz"},{"code":"lsm","name":"铝塑膜","codeAlias":"lsm"},{"code":"ly","name":"旅游","codeAlias":"ly"},{"code":"ly3d","name":"裸眼3D","codeAlias":"ly3d"},{"code":"lzxx","name":"量子信息","codeAlias":"lztx"},{"code":"mhjc","name":"民航机场","codeAlias":"mhjc"},{"code":"mlzg","name":"美丽中国","codeAlias":"mlzg"},{"code":"mt","name":"煤炭","codeAlias":"mt"},{"code":"mtx","name":"明天系","codeAlias":"mtx"},{"code":"myjf","name":"蚂蚁金服","codeAlias":"myjf"},{"code":"myyh","name":"民营银行","codeAlias":"myyh"},{"code":"myyl","name":"民营医院","codeAlias":"myyl"},{"code":"n","name":"镍","codeAlias":"n"},{"code":"njxy","name":"酿酒行业","codeAlias":"bj"},{"code":"nkgg","name":"农垦改革","codeAlias":"nkgg"},{"code":"nyhlw","name":"能源互联网","codeAlias":"nyhlw"},{"code":"nzds","name":"农资电商","codeAlias":"nzds"},{"code":"oled","name":"OLED","codeAlias":"oled"},{"code":"p2p","name":"P2P","codeAlias":"p2p"},{"code":"pdgzgg","name":"浦东国资改革","codeAlias":"pdgzgg"},{"code":"pj","name":"啤酒","codeAlias":"pj"},{"code":"ppp","name":"PPP","codeAlias":"ppp"},{"code":"pta","name":"PTA","codeAlias":"pta"},{"code":"qkl","name":"区块链","codeAlias":"qkl"},{"code":"qs","name":"券商","codeAlias":"qs"},{"code":"qxsj","name":"全息手机","codeAlias":"qxsj"},{"code":"rgzn","name":"人工智能","codeAlias":"rgzn"},{"code":"rldc","name":"燃料电池","codeAlias":"rldc"},{"code":"rlsb","name":"人脸识别","codeAlias":"rlsb"},{"code":"rngc","name":"人脑工程","codeAlias":"rngc"},{"code":"rxdl","name":"柔性电路","codeAlias":"rxdl"},{"code":"rzp2","name":"乳制品","codeAlias":"rzp2"},{"code":"s0gzgg","name":"深圳国资改革","codeAlias":"szgzgg"},{"code":"sgt","name":"深港通","codeAlias":"sgt"},{"code":"shzmq","name":"上海自贸区","codeAlias":"shzmq"},{"code":"slgc","name":"水利工程","codeAlias":"slgc"},{"code":"smx","name":"石墨烯","codeAlias":"smx"},{"code":"spaqjc","name":"食品安全检测","codeAlias":"spaqjc"},{"code":"spyl","name":"食品饮料","codeAlias":"spyl"},{"code":"ss","name":"三沙","codeAlias":"ss"},{"code":"sswgh","name":"十三五规划","codeAlias":"sswgh"},{"code":"stg","name":"ST股","codeAlias":"stg"},{"code":"stny","name":"生态农业","codeAlias":"stny"},{"code":"stzm","name":"ST摘帽","codeAlias":"stzm"},{"code":"swrh","name":"三网融合","codeAlias":"swrh"},{"code":"sy","name":"手游","codeAlias":"sy"},{"code":"sybh","name":"新零售","codeAlias":"sybh"},{"code":"sygg","name":"水域改革","codeAlias":"sygg"},{"code":"szyx","name":"数字营销","codeAlias":"szyx"},{"code":"t","name":"铜","codeAlias":"t"},{"code":"tbf","name":"钛白粉","codeAlias":"tbf"},{"code":"tdlz","name":"土地流转","codeAlias":"tdlz"},{"code":"tgy","name":"特高压","codeAlias":"tgy"},{"code":"tjzmq","name":"天津自贸区","codeAlias":"tjzmq"},{"code":"tl","name":"糖类","codeAlias":"tl"},{"code":"tljj","name":"铁路基建","codeAlias":"tljj"},{"code":"trq","name":"天然气","codeAlias":"trq"},{"code":"trzl","name":"土壤治理","codeAlias":"trzl"},{"code":"tsl","name":"特斯拉","codeAlias":"tsl"},{"code":"ty","name":"体育","codeAlias":"ty"},{"code":"wdsyh","name":"万达私有化","codeAlias":"wdsyh"},{"code":"wh","name":"网红","codeAlias":"wh"},{"code":"whcm","name":"文化传媒","codeAlias":"whcm"},{"code":"wjzz","name":"玩具制造","codeAlias":"wjzz"},{"code":"wlaq2","name":"网络安全","codeAlias":"wlaq2"},{"code":"wlw","name":"物联网","codeAlias":"wlw"},{"code":"wlyx","name":"网络游戏","codeAlias":"wlyx"},{"code":"wrj","name":"无人机","codeAlias":"wrj"},{"code":"wrjs","name":"无人驾驶","codeAlias":"wrjs"},{"code":"wscl2","name":"污水处理","codeAlias":"wscl2"},{"code":"wss","name":"维生素","codeAlias":"wss"},{"code":"wts","name":"梧桐树","codeAlias":"wts"},{"code":"wxcd","name":"无线充电","codeAlias":"wxcd"},{"code":"xbmy","name":"细胞免疫","codeAlias":"xbmy"},{"code":"xdnj","name":"现代农机","codeAlias":"xdnj"},{"code":"xfjr","name":"消费金融","codeAlias":"xfjr"},{"code":"xj2","name":"新疆","codeAlias":"xj2"},{"code":"xnxs","name":"虚拟现实","codeAlias":"xnxs0vr"},{"code":"xny","name":"新能源","codeAlias":"xnyqc"},{"code":"xpgch","name":"芯片国产化","codeAlias":"xpgch"},{"code":"xsb","name":"新三板","codeAlias":"xsb"},{"code":"xtyc","name":"稀土永磁","codeAlias":"xtyc"},{"code":"ydyl","name":"移动医疗","codeAlias":"ydyl"},{"code":"ydyl2","name":"一带一路","codeAlias":"ydyl2"},{"code":"ydzf","name":"移动支付","codeAlias":"ydzf"},{"code":"ydzs","name":"移动转售","codeAlias":"ydzs"},{"code":"yfzg","name":"依法治国","codeAlias":"yfzg"},{"code":"yg","name":"妖股","codeAlias":"yg"},{"code":"ygadwq","name":"粤港澳大湾区","codeAlias":"ygadwq"},{"code":"ygym","name":"乙肝疫苗","codeAlias":"ygym"},{"code":"yjs","name":"云计算","codeAlias":"yjs"},{"code":"ylcy","name":"养老","codeAlias":"ylcy"},{"code":"yqgg","name":"油气改革","codeAlias":"yqgg"},{"code":"yqsxgg","name":"央企四项改革","codeAlias":"yqsxgg"},{"code":"ysjs","name":"有色金属","codeAlias":"ysjs"},{"code":"ytjs","name":"液态金属","codeAlias":"ytjs"},{"code":"yy","name":"医药","codeAlias":"yy"},{"code":"yygg","name":"盐业改革","codeAlias":"yygg"},{"code":"yyq","name":"页岩气","codeAlias":"yyq"},{"code":"zdtx","name":"中电投系","codeAlias":"zdtx"},{"code":"zgdzjt","name":"中国电子集团","codeAlias":"zgdzjt"},{"code":"zhcs","name":"智慧城市","codeAlias":"zhcs"},{"code":"zhx","name":"中航系","codeAlias":"zhx"},{"code":"zhzm","name":"中韩自贸","codeAlias":"zhzm"},{"code":"zjhj","name":"证金汇金","codeAlias":"zjhj"},{"code":"zlx","name":"中粮系","codeAlias":"zlx"},{"code":"zncd","name":"智能穿戴","codeAlias":"zncd"},{"code":"znds","name":"智能电视","codeAlias":"znds"},{"code":"zndw","name":"智能电网","codeAlias":"zndw"},{"code":"znjj","name":"智能家居","codeAlias":"znjj"},{"code":"znwl","name":"智能物流","codeAlias":"znwl"},{"code":"znyx","name":"智能音箱","codeAlias":"znyx"},{"code":"zqxs","name":"增强现实","codeAlias":"zqxs"},{"code":"zr","name":"猪肉","codeAlias":"zr"},{"code":"zxdb","name":"振兴东北","codeAlias":"zxdb"},{"code":"zxjy","name":"在线教育","codeAlias":"zxjy"},{"code":"zxly","name":"在线旅游","codeAlias":"zxly"},{"code":"zzg","name":"债转股","codeAlias":"zzg"},{"code":"zzt","name":"中字头","codeAlias":"zzt"}];
contents={}
with open("news.txt", 'w') as f1:
	with open("related_stocks.txt", 'w') as f2:
		for concept in concepts:
			print()
			print("start processing: "+'http://stock.jrj.com.cn/concept/conceptdetail/conceptDetail_'+concept['codeAlias']+".shtml")
			driver.get('http://stock.jrj.com.cn/concept/conceptdetail/conceptDetail_'+concept['codeAlias']+".shtml")
			html = driver.page_source.encode('utf-8')
			soup= BeautifulSoup(html, 'html.parser')

			#find the trigger event
			trigger_event=soup.find('div', { "class" : "tit-s1" })
			news=trigger_event.find_all('a')[0]['href'].strip()
			description=trigger_event.find_all('p')[0]['title'].strip()
			try:
				driver.get(news)
				news_content= driver.page_source.encode('utf-8')
				with open("jinrongjienews/"+concept["name"]+".txt", 'w') as page:
					page.write(str(news_content))
			except:
				print("Cannot get trigger news for: "+concept['name'])
				print("URL: "+news)
			f1.write(concept['name']+"||"+news+"||"+description+"\n")

			#find related stocks
			related_stocks=soup.find(id="stockTbody").find_all("tr")
			for stock in related_stocks:
				cols=stock.find_all("td")
				stock_code=cols[1].find('a').contents[0].strip()
				stock_name=cols[2].find('a').contents[0].strip()
				stock_reason=cols[5].find('span').contents
				f2.write(concept['name']+"||"+stock_code+"||"+stock_name+"||"+str(stock_reason)+"\n")
		driver.quit()